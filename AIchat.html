<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã“ã„ã®ã¾ãˆï½œæ“¬ä¼¼LINEãƒãƒ£ãƒƒãƒˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--brand:#f88ca4;--ink:#222;--bg:#fff;--bubble:#f5f5f7;--mine:#dff6ec}
  *{box-sizing:border-box}
  body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,sans-serif;background:#fff8fb;color:var(--ink);height:100vh;display:flex;flex-direction:column}
  header{background:var(--brand);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
  header .title{font-weight:900}
  header a{color:#fff;text-decoration:none;opacity:.9}
  .chat{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:#fff}
  .row{display:flex;gap:8px;align-items:flex-end}
  .row.ai{justify-content:flex-start}
  .row.me{justify-content:flex-end}
  .bubble{max-width:75%;padding:10px 14px;border-radius:16px;line-height:1.6;box-shadow:0 1px 1px rgba(0,0,0,.03)}
  .ai .bubble{background:var(--bubble);border-top-left-radius:6px}
  .me .bubble{background:var(--mine);border-top-right-radius:6px}
  .name{font-size:.75rem;color:#777;margin-left:38px;margin-top:-6px}
  .avatar{width:32px;height:32px;border-radius:50%;background:#ffd6e2;display:grid;place-items:center;font-weight:900;color:#b4476b}
  .input{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
  input[type=text]{flex:1;padding:12px 14px;border:1px solid #e7e3ea;border-radius:999px;font-size:1rem}
  button{appearance:none;border:none;border-radius:999px;background:var(--brand);color:#fff;padding:12px 16px;font-size:1rem}
  .typing{display:inline-flex;gap:4px}
  .typing i{width:6px;height:6px;border-radius:50%;background:#bbb;animation:blink 1s infinite}
  .typing i:nth-child(2){animation-delay:.2s}.typing i:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  .top-cta{display:flex;gap:10px}
  .finish{position:sticky;bottom:0;background:#fff;border-top:1px solid #eee;padding:10px;display:flex;gap:8px;justify-content:center}
  .ghost{background:#fff;border:1px solid #eadfe6;color:#333}
</style>
</head>
<body>
<header>
  <span class="title">ã‚ã‹ã­</span>
  <nav class="top-cta">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="form.html">è¨ºæ–­</a>
  </nav>
</header>

<main class="chat" id="chat">
  <div class="row ai"><div class="avatar">ã‚</div><div class="bubble">ã‚„ã£ã»ã€œã€‚æœ€è¿‘ã©ã†ï¼Ÿ</div></div>
  <div class="name">ã‚ã‹ã­</div>
</main>

<div class="input">
  <input id="msg" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" />
  <button id="send">é€ä¿¡</button>
</div>

<div class="finish">
  <button id="scoreBtn" class="ghost">ã“ã®ä¼šè©±ã§æ¡ç‚¹ â†’ çµæœã¸</button>
</div>

<script>
/* ================================
   1) APIæ¥ç¶šè¨­å®š
   - ã‚µãƒ¼ãƒãƒ¬ã‚¹å´ã§ /chat ã¨ /score ã‚’ç”¨æ„ï¼ˆPOSTï¼‰
   - ãªã„å ´åˆã¯è‡ªå‹•ã§ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰
================================ */
const API_BASE = ""; // ä¾‹: "https://your-vercel-app.vercel.app/api"
const DEMO = !API_BASE;

const chatEl = document.getElementById('chat');
const input = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const scoreBtn = document.getElementById('scoreBtn');

const fillers = ["ã†ã‚“","ãªã‚‹ã»ã©ã€œ","ãŸã—ã‹ã«","ãã‚Œã¯æ°—ã«ãªã‚‹","ãµã‚€â€¦","ãˆã€ã„ã„ã˜ã‚ƒã‚“ï¼"];
function rand(a){return a[Math.floor(Math.random()*a.length)]}

/* 2) ä¼šè©±å±¥æ­´ï¼ˆLLMç”¨å½¢å¼ï¼‰ */
let history = [
  { role:"system", content:`ã‚ãªãŸã¯å¤§å­¦1å¹´ã®ã€Œã‚ã‹ã­ã€ã€‚å„ªã—ãè‡ªç„¶ä½“ã€‚æ—¥æœ¬èªã€‚ä¸å¯§ã™ããšãŸã‚å£8å‰²ã€‚
- æ—¢èª­ã®â€œé–“â€ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§çŸ­ãè‡ªç„¶ãªè¿”äº‹ã§OK
- 10ã€œ50å­—ã§ã€ç›¸æ‰‹ã®æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã†ã€‚è³ªå•ã‚’æ™‚ã€…æ··ãœã‚‹
- NG: å€‹äººæƒ…å ±è¦æ±‚/éœ²éª¨/æ”»æ’ƒ/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èª˜å°
`},
  { role:"assistant", content:"ã‚„ã£ã»ã€œã€‚æœ€è¿‘ã©ã†ï¼Ÿ" }
];

/* 3) UI helpers */
function addMe(text){
  const row = document.createElement('div'); row.className='row me';
  const b = document.createElement('div'); b.className='bubble'; b.textContent=text;
  row.appendChild(b); chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
}
function addAi(text){
  const row = document.createElement('div'); row.className='row ai';
  const av = document.createElement('div'); av.className='avatar'; av.textContent='ã‚';
  const b = document.createElement('div'); b.className='bubble'; b.textContent=text;
  row.appendChild(av); row.appendChild(b); chatEl.appendChild(row);
  const nm = document.createElement('div'); nm.className='name'; nm.textContent='ã‚ã‹ã­';
  chatEl.appendChild(nm); chatEl.scrollTop = chatEl.scrollHeight;
}
function typing(on=true){
  if(on){
    const row = document.createElement('div'); row.className='row ai'; row.dataset.typing='1';
    row.innerHTML = `<div class="avatar">ã‚</div><div class="bubble"><span class="typing"><i></i><i></i><i></i></span></div>`;
    chatEl.appendChild(row); chatEl.scrollTop=chatEl.scrollHeight;
  }else{
    const t = chatEl.querySelector('[data-typing]'); if(t) t.remove();
  }
}

/* 4) APIå‘¼ã³å‡ºã— */
async function callChatAPI(messages){
  if(DEMO){
    // ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“è¿”ä¿¡
    const last = messages[messages.length-1]?.content?.toLowerCase()||"";
    let res = rand(fillers);
    if(last.includes("ã‚«ãƒ•ã‚§")||last.includes("coffee")||last.includes("å–«èŒ¶")) res = "ã‚«ãƒ•ã‚§è¡ŒããŸã„ï¼ç”˜ã„ã®é£Ÿã¹ã‚ˆğŸ°";
    else if(last.includes("æ˜ ç”»")||last.includes("ãƒ ãƒ¼ãƒ“ãƒ¼")) res = "æ˜ ç”»ã„ã„ã­ã€ä½•è¦³ãŸã„ï¼Ÿ";
    else if(last.includes("ã²ã¾")||last.includes("æš‡")) res = "å®Ÿã¯ç§ã‚‚â€¦æ•£æ­©ã§ã‚‚ã™ã‚‹ï¼Ÿ";
    else if(last.includes("ã”ã‚ã‚“")||last.includes("é…ã‚Œã¦")) res = "å…¨ç„¶å¤§ä¸ˆå¤«ã ã‚ˆã€œæ°—ã«ã—ãªã„ã§ï¼";
    else if(last.includes("å¥½ã")||last.includes("æ°—ã«ãªã£ã¦ã‚‹")) res = "ãˆã€ã¡ã‚‡ã£ã¨ãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹â€¦ã©ã†ã—ã‚ˆã†ğŸ˜³";
    return res;
  }
  const r = await fetch(`${API_BASE}/chat`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ messages })
  });
  const j = await r.json(); return j.reply;
}

async function callScoreAPI(transcript){
  if(DEMO){
    // ãƒ‡ãƒ¢ã®ç°¡æ˜“æ¡ç‚¹ï¼ˆ0-100ï¼‰
    const t = transcript.join("\n").toLowerCase();
    const len = t.length;
    const qmark = (t.match(/\?/g)||[]).length;
    const sorry = (t.match(/ã”ã‚ã‚“|ã™ã¿ã¾ã›ã‚“/g)||[]).length;
    const emotion = (t.match(/å¬‰|æ¥½|ç·Šå¼µ|ãƒ‰ã‚­ãƒ‰ã‚­|å¥½ã/g)||[]).length;

    const scores = {
      initiative: Math.min(100, 20 + len/8),
      self_disclosure: Math.min(100, 20 + emotion*20),
      empathy: Math.min(100, 30 + qmark*10),
      clarity: Math.min(100, 50),
      pace_balance: 60,
      hesitation: Math.min(100, sorry*25)
    };
    return { scores, flags:{safety:false}, suggestion:"çŸ­ãã¦ã‚‚è‡ªåˆ†ã®æ°—æŒã¡ã‚’ä¸€è¨€æ·»ãˆã¦ã¿ã‚ˆã†ã€‚" };
  }
  const r = await fetch(`${API_BASE}/score`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ transcript: transcript.join("\n") })
  });
  return await r.json();
}

/* 5) é€ä¿¡ */
async function send(){
  const text = input.value.trim(); if(!text) return;
  addMe(text); input.value="";
  history.push({role:"user", content:text});

  typing(true);
  const delay = 800 + Math.random()*900;
  setTimeout(async ()=>{
    const reply = await callChatAPI(history);
    typing(false);
    addAi(reply);
    history.push({role:"assistant", content:reply});
  }, delay);
}
sendBtn.addEventListener('click',send);
input.addEventListener('keydown',e=>{ if(e.key==="Enter") send(); });

/* 6) æ¡ç‚¹â†’çµæœã¸ */
scoreBtn.addEventListener('click', async ()=>{
  // ç›´è¿‘10å¾€å¾©ç¨‹åº¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è©•ä¾¡
  const lines = history.filter(m=>m.role!=="system").map(m=> (m.role==="user" ? "U: " : "A: ")+m.content);
  const result = await callScoreAPI(lines.slice(-20));

  // 0â€“100 â†’ 0â€“20
  const s = result.scores;
  const avg = 0.22*s.initiative + 0.22*s.self_disclosure + 0.20*s.empathy + 0.18*s.clarity + 0.18*s.pace_balance;
  const raw20 = Math.round(avg/5);
  const penalty = Math.min(3, Math.round((s.hesitation||0)/34));
  const chat_raw = Math.max(0, raw20 - penalty);

  // ä¿å­˜ã—ã¦ result.html ã¸
  const data = JSON.parse(localStorage.getItem("KOI_V3")||"{}");
  localStorage.setItem("KOI_V3", JSON.stringify({
    ...data,
    chat_history: history,
    chat_scores: s,
    chat_raw20: chat_raw,
    chat_suggestion: result.suggestion||"",
    safety: result.flags?.safety||false
  }));
  location.href="result.html";
});
</script>
</body>
</html>
