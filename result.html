<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>こいのまえ｜診断結果</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--brand:#f88ca4;--ink:#222;--bg:#fff8fb}
  *{box-sizing:border-box}
  body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--ink);display:flex;flex-direction:column;min-height:100vh}
  header{background:var(--brand);color:#fff;text-align:center;padding:18px}
  main{flex:1;max-width:760px;margin:0 auto;padding:28px 16px;text-align:center}
  .label{color:#666;margin:2px 0 4px}
  .score{font-size:3.2rem;font-weight:900;color:var(--brand);margin:0 0 18px}
  .meter{height:10px;background:#f1dde4;border-radius:999px;overflow:hidden;margin:6px auto 22px;max-width:460px}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,#ffc0d1,var(--brand));width:0;transition:width .6s ease}
  .box{background:#fff;border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.08);text-align:left;padding:26px 20px;margin:0 auto;max-width:740px}
  .type{font-size:1.25rem;font-weight:900;text-align:center;margin:0 0 10px}
  .p{line-height:1.9;margin:0 0 1.1em}
  .hl{font-weight:900}
  .tips{display:grid;gap:10px;margin-top:8px}
  .tip{background:#fff6f9;border:1px solid #ffe3ec;border-radius:12px;padding:10px 12px}
  .cta{display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:999px;padding:12px 20px;font-size:1rem;cursor:pointer}
  .primary{background:var(--brand);color:#fff}
  .ghost{background:#fff;border:1px solid #eadfe6}
  footer{text-align:center;color:#999;padding:18px}
</style>
</head>
<body>
<header><h1>診断結果</h1></header>
<main>
  <div class="label">📊 あなたの恋愛偏差値</div>
  <div id="score" class="score">--</div>
  <div class="meter"><span id="bar"></span></div>

  <div class="box">
    <div id="type" class="type">あなたは「—」タイプ</div>
    <div id="desc" class="p"></div>
    <div id="note" class="p" style="color:#666"></div>
    <div id="chatSug" class="p" style="color:#444"></div>

    <div class="tips">
      <div class="tip" id="tip1"></div>
      <div class="tip" id="tip2"></div>
    </div>

    <div class="cta">
      <a class="btn primary" href="AIchat.html">💬 もう少し練習する</a>
      <a class="btn ghost" href="form.html">診断やり直し</a>
      <a class="btn ghost" href="index.html">ホーム</a>
    </div>
  </div>
</main>
<footer>© <span id="y"></span> こいのまえ / デモ</footer>

<script>
document.getElementById('y').textContent=new Date().getFullYear();
const data = JSON.parse(localStorage.getItem("KOI_V3")||"{}");
const answers = data.answers||[];
const quiz_raw = data.quiz_raw||0;      // 0-20
const quiz_scaled = data.quiz_scaled||55;
const cCount = data.cCount||0;
const chat_raw20 = data.chat_raw20 ?? 10; // 0-20（デモ既定）
const chat_scores = data.chat_scores||{initiative:50,self_disclosure:50,empathy:50,clarity:50,pace_balance:50,hesitation:30};
const suggestion = data.chat_suggestion||"まずは短くても“自分の気持ち”を一言添えてみよう。";

// 最終偏差値（40–70）：診断60% + チャット40%
const finalScaled = 40 + Math.round(30 * (0.6*(quiz_raw/20) + 0.4*(chat_raw20/20)));
document.getElementById('score').textContent = finalScaled;
document.getElementById('bar').style.width = Math.min(Math.max((finalScaled-40)/(70-40),0),1)*100 + "%";

// タイプ判定（診断＋チャット）
function decideType(answers, chat){
  const map={}; answers.forEach((v,i)=>map["q"+(i+1)]=v);
  const keys=["q1","q4","q6","q8"];
  let cautious=0, breakthrough=0;
  keys.forEach(k=>{ if(map[k]==="A") cautious++; if(map[k]==="B") breakthrough++; });

  // チャットで補正
  if((chat.initiative||0) + (chat.self_disclosure||0) > 130) breakthrough++;
  if((chat.empathy||0) > 70) cautious++; // 配慮＝慎重側の傾向加点
  if((chat.hesitation||0) > 60) cautious++;

  if(cCount>=5) return "迷える子羊";
  if(breakthrough - cautious >= 2){
    if(map.q9==="B" || map.q5==="B") return "感情ジェットブースター";
    if(map.q2==="B" || map.q7==="B") return "ロマンチスト型リアクター";
    return "感情ジェットブースター";
  }
  if(cautious - breakthrough >= 2){
    if(map.q3==="A" || map.q4==="A" || map.q9==="A") return "影の共感ナビゲーター";
    return "理屈優位の静かな戦略家";
  }
  if((map.q2==="A" && map.q4==="A") || map.q6==="A") return "理屈優位の静かな戦略家";
  if(map.q3==="A" || map.q9==="A") return "影の共感ナビゲーター";
  if(((chat.initiative||0)+(chat.self_disclosure||0))>120) return "ロマンチスト型リアクター";
  return "理屈優位の静かな戦略家";
}

const type = decideType(answers, chat_scores);
document.getElementById('type').textContent = `あなたは「${type}」タイプ`;

const copy = {
  "影の共感ナビゲーター": `あなたは、<span class="hl">他人の感情の微細な変化に気づける人</span>。その優しさは大きな強み。<br>一方で、<span class="hl">自分の気持ちを後回しにしがち</span>。今日は「これだけは伝える」を一言で。`,
  "理屈優位の静かな戦略家": `あなたは、<span class="hl">状況整理と準備が得意</span>。相手を尊重する姿勢が好印象。<br>ただし、<span class="hl">考えすぎでタイミングを逃す</span>ことも。70点で出していこう。`,
  "ロマンチスト型リアクター": `あなたは、<span class="hl">感受性が豊かで瞬発力が武器</span>。熱量が魅力。<br>ときに、<span class="hl">相手のペースを置き去り</span>に。半歩ゆっくりを意識。`,
  "感情ジェットブースター": `あなたは、<span class="hl">行動力と素直さ</span>が強み。恋愛の“始動”が得意。<br>ただ、<span class="hl">早さが誤解</span>を生むことも。小さな確認を挟もう。`,
  "迷える子羊": `あなたは、<span class="hl">恋愛スタイルを模索中</span>。それは“弱さ”でなく“伸びしろ”。<br>安心できる場から練習を始めよう。`
};
document.getElementById('desc').innerHTML = copy[type] || copy["理屈優位の静かな戦略家"];
if(cCount>=5){
  document.getElementById('note').innerHTML = "<strong>補足：</strong>「どちらとも言えない」が多めでした。今は“探している途中”。少しずつ自分の言葉を増やしていきましょう。";
}
// LLMが返した次の一歩
document.getElementById('chatSug').innerHTML = `<strong>会話からの提案：</strong>${suggestion}`;

const tips = {
  "影の共感ナビゲーター":[
    "LINEの締めに「今日はここが良かった」を一言添える。",
    "会話中に自分の主語を一度だけ使う（例：私はこう感じたよ）。"
  ],
  "理屈優位の静かな戦略家":[
    "「今週10分だけ電話しない？」と短時間の誘いから始める。",
    "準備は70%で出す。残り30%は会話で埋める。"
  ],
  "ロマンチスト型リアクター":[
    "誘う前に「今、話せる？」の確認を一言。",
    "相手の“最近嬉しかったこと”を1つ聞く。"
  ],
  "感情ジェットブースター":[
    "相手の都合を1回だけ確認してから提案する。",
    "返信が早すぎるときは10分だけ待つ習慣を。"
  ],
  "迷える子羊":[
    "AIチャットで「好きな映画を1つ」語ってみる。",
    "友人一人にだけ、最近気になった人の話をしてみる。"
  ]
};
const [t1,t2]=(tips[type]||tips["理屈優位の静かな戦略家"]);
document.getElementById('tip1').textContent=t1;
document.getElementById('tip2').textContent=t2;
</script>
</body>
</html>
